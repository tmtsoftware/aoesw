```plantuml
!pragma teoz true
!include_many participants.puml
!includesub common.puml!variables
hide unlinked

ocs -> aosq ++: AcquireAndLockLgs

aosq -> lgsf ++: setState(OBSERVATION)
note left: Propagate lasers
return Completed

opt If needed
aosq -> lgsfAcq ++: acquire
note left: Check asterism geometry
return Completed
aosq -> aosq : Wait for confirmation to proceed.
end

loop For all LGS subaperatures
aosq -> rtc ++: $TBD
note left: Acquire LGS using Rayleigh backscatter pattern
return Completed
opt If offset required
aosq -> aosq : Wait for LTPM offset
end
aosq -> aosq : Check LGS flux
opt If flux not good
!includesub common.puml!SpiralSearch
end 
end
aosq -> rtc ++: loopLgsTt
note left: RTC to process with CoG and close FSM loop
aosq -> rtc ++: loopLgsFocus
note left: RTC to process with CoG and close trombone loop
return Completed
& return

opt If needed
aosq -> rtc ++: loopLgsTt
note left: Open FSM loop
aosq -> rtc ++: loopLgsFocus
note left: Open trombone loop
return Completed
& return
aosq -> lgsfLaser ++: detune
note left: Detune lasers
return Completed
aosq -> rtc ++: calibLgsBackground
note left: Perform the Rayleigh background calibration
return Completed
aosq -> lgsfLaser ++: detune
note left: Tune lasers back to normal
return Completed
aosq -> rtc ++: loopLgsTt
note left: Close FSM loop
aosq -> rtc ++: loopLgsFocus
note left: Close trombone loop
return Completed
& return
end

aosq -> aosq : Check WFS LGS flux 
opt If needed
aosq -> timing ++: enableTrigger
note left: Adjust sampling frequency
return Completed
end

aosq -> rtc ++: $TBD
note left: Start LGS WFS pixel calibration and gradient computation
return Completed
aosq -> rtc ++: algoSetLgs
note left: Start constrained matched filter update process. When finished,\nswitch gradient computation algorithm to matched filter
return Completed
aosq -> rtc ++: loopHigh
note left: Start high order wavefront reconstruction and\nStart wavefront corrector control to close main AO loop
return Completed

alt If LGS AO Mode
aosq -> rtc ++: loopTwfs
note left: Start LGS ref vector computation from PWFS gradients and RPG
return Completed
end

aosq -> rtc ++: $TBD
note left: Start Slodar process
aosq -> rtc ++: $TBD
note left: Start PSDs computation
aosq -> rtc ++: offloadTcs
note left: Start TCS mode offloading process
return Completed
& return 
& return

return Completed
```